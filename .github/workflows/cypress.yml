name: ðŸš€ Run Cypress on EC2 via SSH

on:
  push:
    branches: [main]

jobs:
  run-cypress-on-ec2:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo (for secrets only)
        uses: actions/checkout@v3

      - name: ðŸ” Setup SSH access to EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts
EOF
- name: ðŸš€ Run Cypress on EC2
  run: |
    ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
      set -e
      cd ~/my-cypress-project

      echo "ðŸ§¹ Resetting Git repo"
      git reset --hard
      git clean -fd
      git pull origin main

      echo "ðŸ“¦ Installing dependencies"
      npm ci

      echo "ðŸ§ª Running Cypress tests"
      mkdir -p cypress/logs
      npx cypress run --env allure=true | tee cypress/logs/test-run.log
      echo "âœ… Cypress tests completed"
    EOF

      - name: â˜ï¸ Upload Cypress artifacts to S3
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
            echo "â˜ï¸ Uploading screenshots (if any)..."
            aws s3 cp cypress/screenshots s3://my-cypress-results-bucket/screenshots --recursive || echo "No screenshots"

            echo "â˜ï¸ Uploading logs..."
            aws s3 cp cypress/logs s3://my-cypress-results-bucket/logs --recursive || echo "No logs"
          EOF

      - name: ðŸ“¬ Send Slack Notification
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
            if [ -f sendNotification.js ]; then
              echo "ðŸ“¬ Sending Slack notification..."
              node sendNotification.js
            else
              echo "âš ï¸ sendNotification.js not found!"
            fi
          EOF
